{function a(a,b){let c=a;for(;"internal"===c.data.type;)if(b<c.data.value)c=c.children[0];else if(b>c.data.value)c=c.children[1];else return c;return c}function b(a,b,c){let d=c.filter(c=>a===c.source&&b===c.target||b===c.source&&a===c.target)[0];return d.source.depth<d.target.depth?[d,!0]:[d,!1]}function c(a,c){if(null!==a.parent){let d=a.parent;if(!(null===a.parent.parent)){let e=d.parent;if(a===d.children[0]&&d===e.children[0]){console.log("left zig-zig");let f=a.children[0],g=a.children[1],h=d.children[1],i=e.children[1],[j,k]=b(a,g,c);k?j.source=d:j.target=d;let[l,m]=b(d,h,c);if(m?l.source=e:l.target=e,a.children[0]=f,a.parent=e.parent,a.children[1]=d,null!==e.parent){let d=e.parent;e===d.children[0]?d.children[0]=a:d.children[1]=a;let[f,g]=b(d,e,c);g?f.target=a:f.source=a}d.children[0]=g,d.children[1]=e,d.parent=a,e.children[0]=h,e.children[1]=i,e.parent=d,g.parent=d,h.parent=e}else if(a===d.children[1]&&d===e.children[1]){console.log("right zig-zig");let f=e.children[0],g=d.children[0],h=a.children[0],i=a.children[1],[j,k]=b(a,h,c);k?j.source=d:j.target=d;let[l,m]=b(d,g,c);if(m?l.source=e:l.target=e,a.parent=e.parent,a.children[0]=d,a.children[1]=i,null!==e.parent){let d=e.parent;e===d.children[0]?d.children[0]=a:d.children[1]=a;let[f,g]=b(d,e,c);g?f.target=a:f.source=a}d.children[0]=e,d.children[1]=h,d.parent=a,e.children[0]=f,e.children[1]=g,e.parent=d,g.parent=e,h.parent=d}else if(a===d.children[1]&&d===e.children[0]){console.log("left zig-zag");let f=d.children[0],g=a.children[0],h=a.children[1],i=e.children[1],[j,k]=b(a,g,c);k?j.source=d:j.target=d;let[l,m]=b(a,h,c);m?l.source=e:l.target=e;let[n,o]=b(e,d,c);if(o?n.target=a:n.source=a,a.parent=e.parent,a.children[0]=d,a.children[1]=e,null!==e.parent){let d=e.parent;e===d.children[0]?d.children[0]=a:d.children[1]=a;let[f,g]=b(d,e,c);g?f.target=a:f.source=a}d.parent=a,d.children[1]=g,e.parent=a,e.children[0]=h,g.parent=d,h.parent=e}else{console.log("right zig-zag");let f=e.children[0],g=a.children[0],h=a.children[1],i=d.children[1],[j,k]=b(a,g,c);k?j.source=e:j.target=e;let[l,m]=b(a,h,c);m?l.source=d:l.target=d;let[n,o]=b(e,d,c);if(o?n.target=a:n.source=a,a.parent=e.parent,a.children[0]=e,a.children[1]=d,null!==e.parent){let d=e.parent;e===d.children[0]?d.children[0]=a:d.children[1]=a;let[f,g]=b(d,e,c);g?f.target=a:f.source=a}d.children[0]=h,d.parent=a,e.children[1]=g,e.parent=a,g.parent=e,h.parent=d}}else if(a===a.parent.children[0]){console.log("left zig");let e=a.children[0],f=a.children[1],g=d.children[1],[h,i]=b(a,f,c);i?h.source=d:h.target=d,f.parent=d,a.children[0]=e,a.children[1]=d,a.parent=null,d.children[0]=f,d.children[1]=g,d.parent=a}else{console.log("right zig");let e=d.children[0],f=a.children[0],g=a.children[1],[h,i]=b(a,f,c);i?h.source=d:h.target=d,f.parent=d,a.children[0]=d,a.children[1]=g,a.parent=null,d.children[0]=e,d.children[1]=f,d.parent=a}}}function d(a){for(let b=[a];0<b.length;){let a=b.pop();a.depth=a.parent?a.parent.depth+1:0,a.children&&b.push(...a.children)}}function e(a){let b=Object.assign(new l({type:"external"}),{parent:a,depth:a.depth+1}),c=Object.assign(new l({type:"external"}),{parent:a,depth:a.depth+1});return a.children=[b,c],a.children}const f=500,g={top:20,right:20,bottom:20,left:20},h=d3.select("div#splay").append("svg").attr("class","svg").style("width",`${600+g.left+g.right}px`).style("height",`${500+g.top+g.bottom}px`).style("font","10px sans-serif");let i=function(a){let b=[...Array(a).keys()];for(let c=0;c<b.length-1;c++){let a=b[c],d=Math.floor(Math.random()*(b.length-c));b[c]=b[d],b[d]=a}return b}(32);const j=d3.tree().size([600,500]),k=d3.linkVertical().source(a=>[a.source.x,a.source.y+(a.source.depth<a.target.depth?2:-9)]).target(a=>[a.target.x,a.target.y+(a.source.depth<a.target.depth?-9:2)]),l=d3.hierarchy.prototype.constructor;let m=h.append("g").attr("fill","none").attr("stroke","#000").attr("transform","translate("+g.left+","+g.top+")").selectAll(".link"),n=h.append("g").attr("text-anchor","middle").attr("transform","translate("+g.left+","+g.top+")").selectAll(".node");var id=-1,root=null;const o=[],p=[],q=()=>{let b=null;if(65<=o.length){let a=Math.floor(Math.random()*32);b=o.filter(b=>b.data.value===a)[0]}else{id+=1,null===root?(b=root=new l({type:"internal",value:i[id]}),o.push(root)):(b=a(root,i[id]),b.data={type:"internal",value:i[id]}),console.log(root.depth);const[c,d]=e(b);o.push(c,d),p.push({source:b,target:c},{source:b,target:d})}const g=()=>{j(root),n=n.data(o),n=n.enter().append("text").attr("x",a=>a.parent?a.parent.px:a.px=a.x).attr("y",a=>a.parent?a.parent.py:a.py=a.y).merge(n).text(a=>"internal"===a.data.type?a.data.value:"\u25A0").style("fill",a=>a===b?"red":"black").style("font",a=>a===b?"bold 10px sans-serif":"10px sans-serif"),m=m.data(p),m=m.enter().insert("path",".node").attr("class","link").attr("d",a=>{const b={x:a.source.px,y:a.source.py};return k({source:b,target:b})}).merge(m);const a=h.transition().duration(f);m.transition(a).attr("d",k),n.transition(a).attr("x",a=>a.px=a.x).attr("y",a=>a.py=a.y)};g();const r=()=>(console.log("splaying"),c(b,p),d(b),null===b.parent)?(console.log(`finished splaying ${b.data.value}`),root=b,g(),d3.timeout(q,1000),!1):(g(),d3.timeout(r,f),!0);return d3.timeout(r,f),!0};d3.timeout(q,500)}
